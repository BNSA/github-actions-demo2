name: Scala CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
    
    - name: Install SBT
      run: |
        echo "deb https://repo.scala-sbt.org/scalasbt/debian all main" | sudo tee /etc/apt/sources.list.d/sbt.list
        echo "deb https://repo.scala-sbt.org/scalasbt/debian /" | sudo tee /etc/apt/sources.list.d/sbt_old.list
        curl -sL "https://keyserver.ubuntu.com/pks/lookup?op=get&search=0x2EE0EA64E40A89B84B2DF73499E82A75642AC823" | sudo apt-key add
        sudo apt-get update
        sudo apt-get install -y sbt
        sbt sbtVersion
    
    - name: Show project structure
      run: |
        echo "=== Current directory ==="
        pwd
        echo ""
        echo "=== Repository structure ==="
        find . -type f -name "*.scala" -o -name "*.sbt" -o -name "*.properties" | head -20
        echo ""
        echo "=== Checking for build.sbt ==="
        ls -la build.sbt || echo "build.sbt NOT FOUND!"
        echo ""
        echo "=== Checking for source files ==="
        ls -la src/main/scala/com/example/*.scala || echo "Source files NOT FOUND!"
        echo ""
        echo "=== Checking for test files ==="
        ls -la src/test/scala/com/example/*.scala || echo "Test files NOT FOUND!"
    
    - name: Compile
      run: sbt compile
    
    - name: Run tests
      run: sbt test
      continue-on-error: true
    
    - name: Check for test reports
      run: |
        echo "=== Looking for test report files ==="
        find . -name "*.xml" -path "*/test-reports/*" 2>/dev/null || echo "No XML test reports found"
        echo ""
        echo "=== Contents of target directory ==="
        ls -R target/ 2>/dev/null || echo "Target directory not found"
    
    - name: Publish Test Report
      uses: dorny/test-reporter@v1
      if: always()
      with:
        name: Scala Test Results
        path: 'target/test-reports/*.xml'
        reporter: java-junit
        fail-on-error: false
    
    - name: Create Test Summary Table
      if: always()
      run: |
        sudo apt-get install -y xmlstarlet bc
        
        echo "## ðŸ“Š Scala Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Check if test reports exist
        if ! ls target/test-reports/*.xml 1> /dev/null 2>&1; then
          echo "### âš ï¸ No test reports found!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This usually means:" >> $GITHUB_STEP_SUMMARY
          echo "- The project structure is incorrect" >> $GITHUB_STEP_SUMMARY
          echo "- Tests didn't run" >> $GITHUB_STEP_SUMMARY
          echo "- SBT configuration is missing" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the 'Show project structure' step above for details." >> $GITHUB_STEP_SUMMARY
          exit 0
        fi
        
        echo "| Test Suite | Total Tests | âœ… Passed | âŒ Failed | â­ï¸ Skipped | â±ï¸ Time |" >> $GITHUB_STEP_SUMMARY
        echo "|------------|-------------|-----------|-----------|------------|---------|" >> $GITHUB_STEP_SUMMARY
        
        total=0
        passed=0
        failed=0
        skipped=0
        total_time=0
        
        for file in target/test-reports/*.xml; do
          if [ -f "$file" ]; then
            suite=$(xmlstarlet sel -t -v "/testsuite/@name" "$file" 2>/dev/null || echo "Unknown")
            tests=$(xmlstarlet sel -t -v "/testsuite/@tests" "$file" 2>/dev/null || echo "0")
            failures=$(xmlstarlet sel -t -v "/testsuite/@failures" "$file" 2>/dev/null || echo "0")
            errors=$(xmlstarlet sel -t -v "/testsuite/@errors" "$file" 2>/dev/null || echo "0")
            skip=$(xmlstarlet sel -t -v "/testsuite/@skipped" "$file" 2>/dev/null || echo "0")
            time=$(xmlstarlet sel -t -v "/testsuite/@time" "$file" 2>/dev/null || echo "0")
            
            fail_count=$((failures + errors))
            pass_count=$((tests - fail_count - skip))
            
            total=$((total + tests))
            passed=$((passed + pass_count))
            failed=$((failed + fail_count))
            skipped=$((skipped + skip))
            total_time=$(echo "$total_time + $time" | bc)
            
            echo "| $suite | $tests | $pass_count | $fail_count | $skip | ${time}s |" >> $GITHUB_STEP_SUMMARY
          fi
        done
        
        echo "|------------|-------------|-----------|-----------|------------|---------|" >> $GITHUB_STEP_SUMMARY
        echo "| **TOTAL** | **$total** | **$passed** | **$failed** | **$skipped** | **${total_time}s** |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "$failed" -eq 0 ] && [ "$total" -gt 0 ]; then
          echo "### âœ… All tests passed!" >> $GITHUB_STEP_SUMMARY
        elif [ "$failed" -gt 0 ]; then
          echo "### âŒ $failed test(s) failed" >> $GITHUB_STEP_SUMMARY
        else
          echo "### âš ï¸ No tests found" >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: Fail if tests failed
      run: |
        if find target/test-reports -name "*.xml" -exec grep -q 'failures="[1-9]' {} \; 2>/dev/null; then
          echo "Tests failed!"
          exit 1
        fi
        if find target/test-reports -name "*.xml" -exec grep -q 'errors="[1-9]' {} \; 2>/dev/null; then
          echo "Tests had errors!"
          exit 1
        fi
        echo "All tests passed!"

        
