name: Scala CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: 'sbt'
    
    - name: Run tests
      run: sbt test
      continue-on-error: true
    
    - name: Publish Test Report
      uses: dorny/test-reporter@v1
      if: always()
      with:
        name: Scala Test Results
        path: 'target/test-reports/*.xml'
        reporter: java-junit
        fail-on-error: false
    
    - name: Create Test Summary Table
      if: always()
      run: |
        # Install XML parser
        sudo apt-get update
        sudo apt-get install -y xmlstarlet bc
        
        echo "## ðŸ“Š Scala Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Test Suite | Total Tests | âœ… Passed | âŒ Failed | â­ï¸ Skipped | â±ï¸ Time |" >> $GITHUB_STEP_SUMMARY
        echo "|------------|-------------|-----------|-----------|------------|---------|" >> $GITHUB_STEP_SUMMARY
        
        total=0
        passed=0
        failed=0
        skipped=0
        total_time=0
        
        # Find and process test XML files
        for file in target/test-reports/*.xml; do
          if [ -f "$file" ]; then
            suite=$(xmlstarlet sel -t -v "/testsuite/@name" "$file" 2>/dev/null || echo "Unknown")
            tests=$(xmlstarlet sel -t -v "/testsuite/@tests" "$file" 2>/dev/null || echo "0")
            failures=$(xmlstarlet sel -t -v "/testsuite/@failures" "$file" 2>/dev/null || echo "0")
            errors=$(xmlstarlet sel -t -v "/testsuite/@errors" "$file" 2>/dev/null || echo "0")
            skip=$(xmlstarlet sel -t -v "/testsuite/@skipped" "$file" 2>/dev/null || echo "0")
            time=$(xmlstarlet sel -t -v "/testsuite/@time" "$file" 2>/dev/null || echo "0")
            
            fail_count=$((failures + errors))
            pass_count=$((tests - fail_count - skip))
            
            total=$((total + tests))
            passed=$((passed + pass_count))
            failed=$((failed + fail_count))
            skipped=$((skipped + skip))
            total_time=$(echo "$total_time + $time" | bc)
            
            echo "| $suite | $tests | $pass_count | $fail_count | $skip | ${time}s |" >> $GITHUB_STEP_SUMMARY
          fi
        done
        
        echo "|------------|-------------|-----------|-----------|------------|---------|" >> $GITHUB_STEP_SUMMARY
        echo "| **TOTAL** | **$total** | **$passed** | **$failed** | **$skipped** | **${total_time}s** |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "$failed" -eq 0 ] && [ "$total" -gt 0 ]; then
          echo "### âœ… All tests passed!" >> $GITHUB_STEP_SUMMARY
        elif [ "$failed" -gt 0 ]; then
          echo "### âŒ $failed test(s) failed" >> $GITHUB_STEP_SUMMARY
        else
          echo "### âš ï¸ No tests found" >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: Check if tests failed
      run: |
        if find target/test-reports -name "*.xml" -exec grep -q 'failures="[1-9]' {} \; 2>/dev/null; then
          echo "Tests failed!"
          exit 1
        fi
        if find target/test-reports -name "*.xml" -exec grep -q 'errors="[1-9]' {} \; 2>/dev/null; then
          echo "Tests had errors!"
          exit 1
        fi
        echo "All tests passed!"
